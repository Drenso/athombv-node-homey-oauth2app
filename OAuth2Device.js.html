<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Source: OAuth2Device.js - Homey OAuth2</title>

  <meta property="og:image" content="https://etc.athom.com/logo/white/256.png" />
  <link rel="icon" href="https://etc.athom.com/logo/transparent/128.png" />
  <link rel="icon" type="image/png" href="https://etc.athom.com/logo/transparent/128.png" />
  <link rel="preload" as="image" href="images/logo.png">
  <link rel="preload" href="styles/homey.min.css" as="style">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link rel="preconnect" href="styles/atom-one-light.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@100;300;400;500;700&display=swap"
        rel="stylesheet">
  <link type="text/css" rel="stylesheet" href="styles/homey.min.css">
</head>

<body>
<div class="container">
  <nav class="navigation container__navigation component">
    <header class="navigation__header">
                <div class="navigation__logo"><a href="index.html"><img class="display-block" src="images/logo.png" width="40" height="40" alt="Homey"></a></div>
                <h2 class="navigation__title"><a href="index.html">Homey OAuth2</a></h2>
                <button data-navigation-toggle class="navigation__button" title="menu"></button>
             </header><div class="navigation__content" data-navigation-target><div class="navigation__search search">
            <input title="filter" placeholder="Filter..." data-navigation-search class="search__input" type="search">
            <button data-navigation-search-reset class="search__reset --mask" type="button" title="Reset"></button>
           </div><div data-navigation-scroll class="navigation__scroll scroll trim"><div class="navigation__menu trim"><nav class="nav-group"><h3 class="nav-group__title">Classes</h3><ul class="nav-group__list"><li data-search-key="oauth2app" class="nav-group__item"><a href="OAuth2App.html">OAuth2App</a></li><li data-search-key="oauth2client" class="nav-group__item"><a href="OAuth2Client.html">OAuth2Client</a></li><li data-search-key="oauth2device" class="nav-group__item"><a href="OAuth2Device.html">OAuth2Device</a></li><li data-search-key="oauth2driver" class="nav-group__item"><a href="OAuth2Driver.html">OAuth2Driver</a></li><li data-search-key="oauth2error" class="nav-group__item"><a href="OAuth2Error.html">OAuth2Error</a></li><li data-search-key="oauth2token" class="nav-group__item"><a href="OAuth2Token.html">OAuth2Token</a></li><li data-search-key="oauth2util" class="nav-group__item"><a href="OAuth2Util.html">OAuth2Util</a></li></ul></nav></div></div></div>
  </nav>

  <main id="main" class="main container__main">
    
  
  
  <div class="main__center">
    <div class="main__content align-baseline">
      <h1 class="text-preset-heading-1">
        Source: OAuth2Device.js
      </h1>
      
    <section>
        <article>
            <pre class="source linenums"><code>'use strict';

const Homey = require('homey');
const OAuth2Error = require('./OAuth2Error');

/**
 * @class OAuth2Device
 * @extends Homey.Device
 * @type {module.OAuth2Device}
 * @hideconstructor
 */
class OAuth2Device extends Homey.Device {

  /**
   */
  async onInit() {
    // Migrate
    if (typeof this.onOAuth2Migrate === 'function') {
      try {
        const {
          OAuth2SessionId,
          OAuth2ConfigId,
        } = this.getStore();

        if (!OAuth2SessionId || !OAuth2ConfigId) {
          this.log('Starting migration...');
          const result = await this.onOAuth2Migrate();
          if (!result) {
            throw new OAuth2Error('Migration Failed');
          }

          const {
            sessionId,
            configId,
            token,
            title = null,
          } = result;

          let client;
          const hasClient = this.homey.app.hasOAuth2Client({
            sessionId,
            configId,
          });
          if (!hasClient) {
            client = this.homey.app.createOAuth2Client({
              sessionId,
              configId,
            });
            client.setToken({ token });
            client.setTitle({ title });
            client.save();
          }

          this.setStoreValue('OAuth2SessionId', sessionId);
          this.setStoreValue('OAuth2ConfigId', configId);

          if (typeof this.onOAuth2MigrateSuccess === 'function') {
            await this.onOAuth2MigrateSuccess();
          }

          this.log('Migration success!');
        }
      } catch (err) {
        await this.setUnavailable('Migration failed. Please re-authorize.');
        this.error(err);
        return;
      }
    }

    // Init
    const {
      OAuth2SessionId,
      OAuth2ConfigId,
    } = this.getStore();

    if (!OAuth2ConfigId) {
      throw new OAuth2Error('Missing OAuth2ConfigId');
    }

    if (!OAuth2SessionId) {
      throw new OAuth2Error('Missing OAuth2SessionId');
    }

    this.oAuth2Client = this.homey.app.getOAuth2Client({
      sessionId: OAuth2SessionId,
      configId: OAuth2ConfigId,
    });
    this.oAuth2Client.on('save', () => {
      this.onOAuth2Saved().catch(this.error);
    });

    await this.onOAuth2Init();
  }

  /**
   * @description
   * > This method can be extended
   * @returns {Promise&lt;void>}
   */
  async onOAuth2Init() {
    // Extend me
  }

  /**
   * @returns {Promise&lt;void>}
   */
  async onUninit() {
    await this.onOAuth2Uninit();
  }

  /**
   * @description
   * > This method can be extended
   * @returns {Promise&lt;void>}
   */
  async onOAuth2Uninit() {
    // Extend me
  }

  /**
   * @returns {Promise&lt;void>}
   */
  async onAdded() {
    await this.onOAuth2Added();
  }

  /**
   * @description
   * > This method can be extended
   * @returns {Promise&lt;void>}
   */
  async onOAuth2Added() {
    // Extend me
  }

  /**
   * @description
   * > This method can be extended
   * @returns {Promise&lt;void>}
   */
  async onOAuth2Saved() {
    // Extend me
  }

  /**
   * @returns {Promise&lt;void>}
   */
  async onDeleted() {
    const {
      OAuth2SessionId,
      OAuth2ConfigId,
    } = this.getStore();

    if (OAuth2SessionId &amp;&amp; OAuth2ConfigId) {
      this.homey.app.tryCleanSession({
        sessionId: OAuth2SessionId,
        configId: OAuth2ConfigId,
      });
    }

    await this.onOAuth2Deleted();
  }

  /**
   * @description
   * > This method can be extended
   * @returns {Promise&lt;void>}
   */
  async onOAuth2Deleted() {
    // Extend me
  }

}

module.exports = OAuth2Device;
</code></pre>
        </article>
    </section>
    </div>
  </div>
  



  </main>
</div>

<script src="scripts/ready.js"></script>
<script src="scripts/navigation.js"></script>
<script src="scripts/toc.js"></script>
<script src="scripts/table.js"></script>

<link type="text/css" rel="stylesheet" href="styles/atom-one-light.css">
<script src="scripts/highlight.min.js"></script>
<!--<script src="scripts/linenumber.js"></script>-->

<script async defer src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
<noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt="" referrerpolicy="no-referrer-when-downgrade" /></noscript>

</body>
</html>
