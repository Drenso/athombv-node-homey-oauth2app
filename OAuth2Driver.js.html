<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Source: OAuth2Driver.js - Homey OAuth2</title>

  <meta property="og:image" content="https://etc.athom.com/logo/white/256.png" />
  <link rel="icon" href="https://etc.athom.com/logo/transparent/128.png" />
  <link rel="icon" type="image/png" href="https://etc.athom.com/logo/transparent/128.png" />
  <link rel="preload" as="image" href="images/logo.png">
  <link rel="preload" href="styles/homey.min.css" as="style">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link rel="preconnect" href="styles/atom-one-light.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@100;300;400;500;700&display=swap"
        rel="stylesheet">
  <link type="text/css" rel="stylesheet" href="styles/homey.min.css">
</head>

<body>
<div class="container">
  <nav class="navigation container__navigation component">
    <header class="navigation__header">
                <div class="navigation__logo"><a href="index.html"><img class="display-block" src="images/logo.png" width="40" height="40" alt="Homey"></a></div>
                <h2 class="navigation__title"><a href="index.html">Homey OAuth2</a></h2>
                <button data-navigation-toggle class="navigation__button" title="menu"></button>
             </header><div class="navigation__content" data-navigation-target><div class="navigation__search search">
            <input title="filter" placeholder="Filter..." data-navigation-search class="search__input" type="search">
            <button data-navigation-search-reset class="search__reset --mask" type="button" title="Reset"></button>
           </div><div data-navigation-scroll class="navigation__scroll scroll trim"><div class="navigation__menu trim"><nav class="nav-group"><h3 class="nav-group__title">Classes</h3><ul class="nav-group__list"><li data-lvl="0" data-search-key="oauth2app" class="nav-group__item"><a href="OAuth2App.html"> OAuth2App</a></li><li data-lvl="0" data-search-key="oauth2client" class="nav-group__item"><a href="OAuth2Client.html"> OAuth2Client</a></li><li data-lvl="0" data-search-key="oauth2device" class="nav-group__item"><a href="OAuth2Device.html"> OAuth2Device</a></li><li data-lvl="0" data-search-key="oauth2driver" class="nav-group__item"><a href="OAuth2Driver.html"> OAuth2Driver</a></li><li data-lvl="0" data-search-key="oauth2error" class="nav-group__item"><a href="OAuth2Error.html"> OAuth2Error</a></li><li data-lvl="0" data-search-key="oauth2token" class="nav-group__item"><a href="OAuth2Token.html"> OAuth2Token</a></li><li data-lvl="0" data-search-key="oauth2util" class="nav-group__item"><a href="OAuth2Util.html"> OAuth2Util</a></li></ul></nav></div></div></div>
  </nav>

  <main id="main" class="main container__main">
    
  
  
  <div class="main__center">
    <div class="main__content align-baseline">
      <h1 class="text-preset-heading-1">
        Source: OAuth2Driver.js
      </h1>
      
    <section>
        <article>
            <pre class="source linenums"><code>'use strict';

const Homey = require('homey');
const OAuth2Util = require('./OAuth2Util');
const OAuth2Error = require('./OAuth2Error');

const sOAuth2ConfigId = Symbol('oAuth2ConfigId');

/**
 * @class OAuth2Driver
 * @extends Homey.Driver
 * @type {module.OAuth2Driver}
 * @hideconstructor
 */
class OAuth2Driver extends Homey.Driver {

  /**
   * @returns {Promise&lt;void>}
   */
  async onInit() {
    this.setOAuth2ConfigId('default');
    await this.onOAuth2Init();
  }

  /**
   * @description
   * > This method can be extended
   * @returns {Promise&lt;void>}
   */
  async onOAuth2Init() {
    // Extend me
  }

  /**
   * @returns {*}
   */
  getOAuth2ConfigId() {
    return this[sOAuth2ConfigId];
  }

  /**
   * @param {string} id
   */
  setOAuth2ConfigId(id) {
    if (typeof id !== 'string') {
      throw new OAuth2Error('Invalid Config ID');
    }

    this[sOAuth2ConfigId] = id;
  }

  /**
   * @param {PairSession} socket
   */
  onPair(socket) {
    const OAuth2ConfigId = this.getOAuth2ConfigId();
    let OAuth2SessionId = '$new';
    let currentViewId = 'list_sessions';
    let client = this.homey.app.createOAuth2Client({
      sessionId: OAuth2Util.getRandomId(),
      configId: OAuth2ConfigId,
    });

    const OAuth2Config = this.homey.app.getConfig({
      configId: OAuth2ConfigId,
    });
    const { allowMultiSession } = OAuth2Config;
    if (!allowMultiSession) {
      const savedSessions = this.homey.app.getSavedOAuth2Sessions();
      if (Object.keys(savedSessions).length) {
        OAuth2SessionId = Object.keys(savedSessions)[0];
        try {
          client = this.homey.app.getOAuth2Client({
            configId: OAuth2ConfigId,
            sessionId: OAuth2SessionId,
          });
          this.log(`Multi-Session disabled. Selected ${OAuth2SessionId} as active session.`);
        } catch (err) {
          this.error(err);
        }
      }
    }

    const onShowViewLoginCredentials = () => {
      if (OAuth2SessionId !== '$new') {
        socket.nextView();
      }
    };

    const onLogin = async ({ username, password }) => {
      await client.getTokenByCredentials({ username, password });
      const session = await client.onGetOAuth2SessionInformation();

      OAuth2SessionId = session.id;
      const token = client.getToken();
      const { title } = session;
      client.destroy();

      // replace the temporary client by the final one and save it
      client = this.homey.app.createOAuth2Client({
        sessionId: session.id,
        configId: OAuth2ConfigId,
      });
      client.setTitle({ title });
      client.setToken({ token });

      return true;
    };

    /**
     * @returns {Promise&lt;void>}
     */
    const onShowViewLoginOAuth2 = async () => {
      if (OAuth2SessionId !== '$new') {
        socket.emit('authorized');
        return;
      }

      try {
        const oAuth2AuthorizationUrl = client.getAuthorizationUrl();
        const oAuth2Callback = await this.homey.cloud.createOAuth2Callback(oAuth2AuthorizationUrl);
        oAuth2Callback
          .on('url', url => {
            socket.emit('url', url);
          })
          .on('code', code => {
            client.getTokenByCode({ code })
              .then(async () => {
                // get the client's session info
                const session = await client.onGetOAuth2SessionInformation();
                OAuth2SessionId = session.id;
                const token = client.getToken();
                const { title } = session;
                client.destroy();

                // replace the temporary client by the final one and save it
                client = this.homey.app.createOAuth2Client({
                  sessionId: session.id,
                  configId: OAuth2ConfigId,
                });
                client.setTitle({ title });
                client.setToken({ token });

                socket.emit('authorized');
              })
              .catch(err => {
                socket.emit('error', err.message || err.toString());
              });
          });
      } catch (err) {
        socket.emit('error', err.message || err.toString());
      }
    };

    const onShowView = async viewId => {
      currentViewId = viewId;
      if (viewId === 'login_oauth2') {
        onShowViewLoginOAuth2();
      } else if (viewId === 'login_credentials') {
        onShowViewLoginCredentials();
      }
    };

    const onListSessions = async () => {
      if (!allowMultiSession) {
        throw new Error('Multi-Session is disabled.\nPlease remove the list_devices from your App\'s manifest or allow Multi-Session support.');
      }

      const savedSessions = this.homey.app.getSavedOAuth2Sessions();
      const result = Object.keys(savedSessions).map((sessionId, i) => {
        const session = savedSessions[sessionId];
        return {
          name: session.title || `Saved User ${i + 1}`,
          data: { id: sessionId },
        };
      });

      result.push({
        name: 'New User',
        data: {
          id: '$new',
        },
      });

      return result;
    };

    const onListSessionsSelection = async ([selection]) => {
      if (!allowMultiSession) {
        throw new Error('Multi-Session is disabled.');
      }

      const { id } = selection.data;

      OAuth2SessionId = id;
      this.log(`Selected session ${OAuth2SessionId}`);

      if (OAuth2SessionId !== '$new') {
        client = this.homey.app.getOAuth2Client({
          configId: OAuth2ConfigId,
          sessionId: OAuth2SessionId,
        });
      }
    };

    const onListDevices = async data => {
      if (currentViewId === 'list_sessions') {
        return onListSessions(data);
      }

      const devices = await this.onPairListDevices({
        oAuth2Client: client,
      });

      return devices.map(device => {
        return {
          ...device,
          store: {
            ...device.store,
            OAuth2SessionId,
            OAuth2ConfigId,
          },
        };
      });
    };

    const onAddDevice = async () => {
      this.log('At least one device has been added, saving the client...');
      client.save();
    };

    const onDisconnect = async () => {
      this.log('Pair Session Disconnected');
    };

    socket
      .setHandler('showView', onShowView)
      .setHandler('login', onLogin)
      .setHandler('list_sessions', onListSessions)
      .setHandler('list_sessions_selection', onListSessionsSelection)
      .setHandler('list_devices', onListDevices)
      .setHandler('add_device', onAddDevice)
      .setHandler('disconnect', onDisconnect);
  }

  /**
   * @description
   * > This method can be extended
   * @returns {Promise&lt;*>}
   */
  async onPairListDevices() {
    // Extend me
    return [];
  }

  /**
   * @param {PairSession} socket
   * @param {Homey.Device} device
   */
  onRepair(socket, device) {
    let client;

    let {
      OAuth2SessionId,
      OAuth2ConfigId,
    } = device.getStore();

    if (!OAuth2SessionId) {
      OAuth2SessionId = OAuth2Util.getRandomId();
    }

    if (!OAuth2ConfigId) {
      OAuth2ConfigId = this.getOAuth2ConfigId();
    }

    // Get the Device's OAuth2Client
    // Or create it when it doesn't exist
    try {
      client = this.homey.app.getOAuth2Client({
        sessionId: OAuth2SessionId,
        configId: OAuth2ConfigId,
      });
    } catch (err) {
      client = this.homey.app.createOAuth2Client({
        sessionId: OAuth2SessionId,
        configId: OAuth2ConfigId,
      });
    }

    const onShowViewLoginOAuth2 = async () => {
      try {
        const oAuth2AuthorizationUrl = client.getAuthorizationUrl();
        const oAuth2Callback = await this.homey.cloud.createOAuth2Callback(oAuth2AuthorizationUrl);
        oAuth2Callback
          .on('url', url => {
            socket.emit('url', url);
          })
          .on('code', code => {
            client.getTokenByCode({ code })
              .then(async () => {
                await device.onOAuth2Uninit();
                await device.setStoreValue('OAuth2SessionId', OAuth2SessionId);
                await device.setStoreValue('OAuth2ConfigId', OAuth2ConfigId);
                await client.save();
                device.oAuth2Client = client;
                await device.onOAuth2Init();

                socket.emit('authorized');
              })
              .catch(err => {
                socket.emit('error', err.message || err.toString());
              });
          });
      } catch (err) {
        socket.emit('error', err.message || err.toString());
      }
    };

    const onShowView = async viewId => {
      if (viewId === 'login_oauth2') {
        await onShowViewLoginOAuth2();
      }
    };

    const onDisconnect = async () => {
      this.log('Pair Session Disconnected');
    };

    socket
      .setHandler('showView', onShowView)
      .setHandler('disconnect', onDisconnect);
  }

}

module.exports = OAuth2Driver;
</code></pre>
        </article>
    </section>
    </div>
  </div>
  



  </main>
</div>

<script src="scripts/ready.js"></script>
<script src="scripts/navigation.js"></script>
<script src="scripts/toc.js"></script>
<script src="scripts/table.js"></script>

<link type="text/css" rel="stylesheet" href="styles/atom-one-light.css">
<script src="scripts/highlight.min.js"></script>
<!--<script src="scripts/linenumber.js"></script>-->


<script async defer src="https://sa.athom.com/latest.js"></script>

</body>
</html>
